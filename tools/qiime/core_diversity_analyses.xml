<tool id="qiime_core_diversity" name="Compute core set of diversity analyses" version="1.9.1">
    <description></description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <version_command><![CDATA[
        core_diversity_analyses.py --version
    ]]>
    </version_command>

    <command>
<![CDATA[
        core_diversity_analyses.py 
            -i $input_biom_fp 
            -o core_diversity_analyses
            -m $mapping_fp
            -e $sampling_depth

            #if $parameter_fp
                -p $parameter_fp
            #end if

            $parallel
            -O "\${GALAXY_SLOTS:-4}"

            #if $phylogenetic.nonphylogenetic_diversity
                --nonphylogenetic_diversity
            #else
                -t $phylogenetic.tree_fp
            #end if

            $suppress_taxa_summary
            $suppress_beta_diversity
            $suppress_alpha_diversity
            $suppress_group_significance

            #if $categories
                -c $categories
            #end if

        &&
        mkdir -p $html_report.files_path 
        &&
        cp -r core_diversity_analyses/* $html_report.files_path  
        && 
        mv $html_report.files_path/index.html $html_report
]]>
    </command>

    <inputs>
        <param name="input_biom_fp" type="data" format="tabular,txt,tsv,biom" 
            label="OTU table" help="(-i/--input_biom_fp)"/>

        <param name="mapping_fp" type="data" format="tabular,txt,tsv" 
            label="Mapping file" help="(-m/--mapping_fp)"/>

        <param name="sampling_depth" type="integer" value="" label="Sequencing 
            depth to use for even sub-sampling and maximum rarefaction depth" 
            help="To decide this value, review the output of the 
            ‘biom summarize-table’ (-e/--sampling_depth)"/>

        <param name="parameter_fp" type="data" format="txt" 
            label="Parameter file" help="It specifies changes to the default 
            behavior (-p/--parameter_fp)" optional="true"/>

        <param name="parallel" type="boolean" label="Run in parallel where 
            available?" truevalue="--parallel" falsevalue="" checked="true" 
            help="(-a, --parallel)" />

        <conditional name="phylogenetic">
            <param name="nonphylogenetic_diversity" type="boolean" label="Apply 
                non-phylogenetic alpha (chao1 and observed_otus) and beta (bray_curtis) 
                diversity calculations?" truevalue="--nonphylogenetic_diversity" 
                falsevalue="" checked="false" help="This is useful if, for example, 
                when working with non-amplicon BIOM tables, or if a reliable tree 
                is not available (--nonphylogenetic_diversity)" /> 
            <when value="false" >
                <param name="tree_fp" type="data" format="txt" 
                    label="Tree file" help="(-t/--tree_fp)"/>
            </when>
            <when value="true" />
        </conditional>

        <param name="suppress_taxa_summary" type="boolean" label="Suppress 
            generation of taxa summary plots?" truevalue="--suppress_taxa_summary" 
            falsevalue="" checked="False" help="(--suppress_taxa_summary)" /> 

        <param name="suppress_beta_diversity" type="boolean" label="Suppress 
            beta diversity analyses?" truevalue="--suppress_beta_diversity" 
            falsevalue="" checked="False" help="(--suppress_beta_diversity)" /> 

        <param name="suppress_alpha_diversity" type="boolean" label="Suppress 
            alpha diversity analyses?" truevalue="--suppress_alpha_diversity" 
            falsevalue="" checked="False" help="(--suppress_alpha_diversity)" />

        <param name="suppress_group_significance" type="boolean" label="Suppress 
            OTU/category significance analysis?" truevalue="--suppress_group_significance" 
            falsevalue="" checked="False" help="(--suppress_group_significance)" /> 

        <param name="categories" type="text" value="" label="Metadata category or 
            categories to compare for categorical analyses (optional)" 
            help="The column headers in the mapping file should be passed as a 
            comma-separated list. By default, no categorical analyses are performed
            (-c/--categories)" optional="true"/>

    </inputs>

    <outputs>
        <data name="html_report" format="html" 
            label="${tool.name} on ${on_string}: Core diversity report" />
    </outputs>

    <tests>
        <test>
        </test>
    </tests>

    <help><![CDATA[

**What it does?**

This tool calculates alpha diversity, or within-sample diversity, using an
OTU table.

The resulting file(s) is a tab-delimited text file, where the columns correspond 
to alpha diversity metrics and the rows correspond to samples and their calculated 
diversity measurements. When a folder is given as input (-i), the script processes 
every otu table file in the given folder, and creates a corresponding file in the 
output directory.

More information about this tool is available on 
`QIIME documentation <http://qiime.org/scripts/alpha_diversity.html>`_.
    ]]>
    </help>

    <citations>
        <expand macro="citations" />
    </citations>
</tool>
