<tool id="qiime_summarize_taxa" name="Summarize taxa" version="1.9.1">
    <description>and store results in a new table or appended to an existing 
        mapping file
    </description>
    
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements" />

    <version_command><![CDATA[
        summarize_taxa.py --version
    ]]>
    </version_command>

    <command>
<![CDATA[
        summarize_taxa.py 
            -i $otu_table_fp
            -o summarize_taxa

            -L $level

            #if str($mapping) != 'None':
                -m $mapping
            #end if

            --md_identifier $md_identifier

            $md_as_string

            $absolute_abundance

            #if str( $lower_percentage )
                -l $lower_percentage
            #end if

            #if str( $upper_percentage)
                -u $upper_percentage
            #end if

            $transposed_output             
            $suppress_classic_table_output
            $suppress_biom_table_output
]]>
    </command>

    <inputs>
        <param name="otu_table_fp" type="data" format="biom,tabular" 
            label="Input OTU table" help="(-i/--otu_table_fp)"/> 

        <param name="level" type="select" label="Taxonomic level to summarize by"
            help="(-L/--level)" multiple="True" display="checkboxes">
            <option value="1" >Kingdom</option>
            <option value="2" selected="true">Phylum</option>
            <option value="3" selected="true">Class</option>
            <option value="4" selected="true">Order</option>
            <option value="5" selected="true">Family</option>
            <option value="6" selected="true">Genus</option>
            <option value="7" >Species</option>
        </param>

        <param name="mapping" type="data" format="tabular,tsv,csv" 
            label="Input metadata mapping (optional)" help="If supplied, then the 
            taxon information will be added to this file. This option is useful for 
            coloring PCoA plots by taxon abundance or to perform statistical 
            tests of taxon/mapping associations (-m/--mapping)" optional="True"/>

        <param name="md_identifier" type="text" value="taxonomy" label="Relevant 
            observation metadata key"  help="(--md_identifier)" />

        <param name="md_as_string" type="boolean" label="Include metadata as string?" 
            truevalue="--md_as_string" falsevalue="" checked="False" 
            help="By default, metadata is included as list (--md_as_string)" />

        <param name="absolute_abundance" type="boolean" label="Report absolute
            abundance?" truevalue="--absolute_abundance" falsevalue="" checked="False" 
            help="By default, relative abundance is reported (--absolute_abundance)" />

        <param name="lower_percentage" type="float" label="Percentage threshold to
            remove highly present OTU (optional)" help="If present, OTUs having 
            higher absolute abundance are trimmed. To remove OTUs that make up 
            more than 5% of the total dataset you would pass 0.05 (-l/--lower_percentage)" 
            optional="True"/>

        <param name="upper_percentage" type="float" label="Percentage threshold to
            remove lowly present OTU (optional)" help="If present, OTUs having 
            lower absolute abundance are trimmed. To remove the OTUs that 
            makes up less than 45% of the total dataset you would pass 0.45 
            (-u/--upper_percentage)" optional="True"/>

        <param name="transposed_output" type="boolean" label="Transpose output?" 
            truevalue="--transposed_output" falsevalue="" checked="False" 
            help="If checked, the output will be written transposed from the 
            regular output. This is helpful in cases when you want to use Site 
            Painter to visualize your data (-t/--transposed_output)" />

        <param name="suppress_classic_table_output" type="boolean" 
            label="Suppress creation of the classic (TSV) format taxon table?" 
            truevalue="--suppress_classic_table_output" falsevalue="" checked="False" 
            help="This option is ignored if a mapping file is present 
            (--suppress_classic_table_output)" />

        <param name="suppress_biom_table_output" type="boolean" 
            label="Suppress creation of the BIOM-formatted taxon table?" 
            truevalue="--suppress_biom_table_output" falsevalue="" checked="False" 
            help="This option is ignored if a mapping file is present 
            (--suppress_biom_table_output)" />
    </inputs>

    <outputs>
        <data name="L1_tab" format="tabular" from_work_dir="summarize_taxa/*_L1.txt" 
            label="${tool.name} on ${on_string}: L1 tab">
            <filter>"1" in level and suppress_classic_table_output is False</filter>
        </data> 

        <data name="L2_tab" format="tabular" from_work_dir="summarize_taxa/*_L2.txt" 
            label="${tool.name} on ${on_string}: L2 tab">
            <filter>"2" in level and suppress_classic_table_output is False</filter>
        </data> 

        <data name="L3_tab" format="tabular" from_work_dir="summarize_taxa/*_L3.txt" 
            label="${tool.name} on ${on_string}: L3 tab">
            <filter>"3" in level and suppress_classic_table_output is False</filter>
        </data> 

        <data name="L4_tab" format="tabular" from_work_dir="summarize_taxa/*_L4.txt" 
            label="${tool.name} on ${on_string}: L4 tab">
            <filter>"4" in level and suppress_classic_table_output is False</filter>
        </data> 

        <data name="L5_tab" format="tabular" from_work_dir="summarize_taxa/*_L5.txt" 
            label="${tool.name} on ${on_string}: L5 tab">
            <filter>"5" in level and suppress_classic_table_output is False</filter>
        </data> 

        <data name="L6_tab" format="tabular" from_work_dir="summarize_taxa/*_L6.txt" 
            label="${tool.name} on ${on_string}: L6 tab">
            <filter>"6" in level and suppress_classic_table_output is False</filter>
        </data> 

        <data name="L7_tab" format="tabular" from_work_dir="summarize_taxa/*_L7.txt" 
            label="${tool.name} on ${on_string}: L7 tab">
            <filter>"7" in level and suppress_classic_table_output is False</filter>
        </data> 
    </outputs>

    <tests>
        <test>
            <param name="otu_table_fp" 
                value="pick_open_reference_otus_otu_table_with_taxo.biom"/> 
            <param name="level" value="2,3,4,5,6" />
            <param name="mapping" 
                value="validate_mapping_file_corrected_map.tabular"/>
            <param name="md_identifier" value="taxonomy"/>
            <param name="md_as_string" value=""/>
            <param name="delimiter" value=";" />
            <param name="absolute_abundance" value=""/>
            <param name="transposed_output" value=""/>
            <param name="suppress_classic_table_output" value="" />
            <param name="suppress_biom_table_output" value="" /> 

            <output name="L2_tab" value="summarize_taxa_L2.tabular" /> 
            <output name="L3_tab" value="summarize_taxa_L3.tabular" /> 
            <output name="L4_tab" value="summarize_taxa_L4.tabular" /> 
            <output name="L5_tab" value="summarize_taxa_L5.tabular" /> 
            <output name="L6_tab" value="summarize_taxa_L6.tabular" /> 
        </test>
    </tests>

    <help><![CDATA[

**What it does**

This tool provides summary information of the representation of taxonomic groups within each sample. It takes an OTU table that contains taxonomic information as input. 

More information about this tool is available on 
`QIIME documentation <http://qiime.org/scripts/summarize_taxa.html>`_.
    ]]>
    </help>

    <citations>
        <expand macro="citations" />
    </citations>
</tool>
