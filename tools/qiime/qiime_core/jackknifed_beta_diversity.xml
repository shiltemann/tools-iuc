<tool id="qiime_jackknifed_beta_diversity" name="Perform jackknifed UPGMA clustering" version="@WRAPPER_VERSION@.0">
    
    <description>and building jackknifed PCoA plots</description>
    
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <expand macro="requirements"/>
    
    <stdio>
        <regex match="VisibleDeprecationWarning" source="both" level="warning" description="VisibleDeprecationWarning on numpy for `rank`"/>
        <regex match="RuntimeWarning: The result contains negative eigenvalues" source="both" level="warning" description="Presence of negative eigenvalues"/>
    </stdio>
    
    <version_command>jackknifed_beta_diversity.py --version</version_command>
    
    <command detect_errors="aggressive"><![CDATA[
        jackknifed_beta_diversity.py
            --otu_table_fp '$otu_table_fp'
            --mapping_fp '$mapping_fp'
            -o jackknifed_beta_diversity
            --seqs_per_sample '$seqs_per_sample'
            #if $tree_fp
                --tree_fp '$tree_fp'
            #end if
            #if $parameter_fp
                --parameter_fp '$parameter_fp'
            #end if
            --master_tree '$master_tree'
            $parallel
            -O "\${GALAXY_SLOTS:-4}"

        && python $__tool_directory__/jackknifed_beta_diversity_through_plots_html_generation.py
            --data_directory jackknifed_beta_diversity
            --html_file '$jackknifed_beta_diversity_report'
            --html_dir '$jackknifed_beta_diversity_report.files_path'

        && cd jackknifed_beta_diversity/
        && mkdir -p pcoa
        && mkdir -p rare_dm
        && mkdir -p rare_upgma
        && mkdir -p rare_upgma_consensus
        && mkdir -p upgma_cmp
        && for f in *; do 
            if [[ ! "\$f" =~ .*rarefaction.* && ! "\$f" =~ .*unrarefied_bdiv.* && ! "\$f" =~ .*txt.* && ! "\$f" =~ .*pcoa.* && ! "\$f" =~ .*rare_dm.* && ! "\$f" =~ .*rare_upgma.* && ! "\$f" =~ .*rare_upgma_consensus.* && ! "\$f" =~ .*upgma_cmp.* ]]; then
                mv \$f/pcoa/* pcoa; 
                mv \$f/rare_dm/* rare_dm; 
                mv \$f/rare_upgma/* rare_upgma; 
                mv \$f/upgma_cmp/* upgma_cmp; 
                mv "\$f/rare_upgma_consensus.tre" "rare_upgma_consensus/\$f.tree"; 
            fi; 
        done        
    ]]></command>
    
    <inputs>
        <param argument="--otu_table_fp" type="data" format="tabular,txt,biom" label="OTU table" multiple="True"/>
        <param argument="--mapping_fp" type="data" format="tabular,txt,tsv" label="Mapping file" multiple="True"/>
        <param argument="--seqs_per_sample" type="integer" value="" label="Number of sequences to include in each jackknifed subset"/>
        <param argument="--tree_fp" type="data" format="txt" label="Tree file" help="It is required for phylogenetic measures" optional="True"/>
        <param argument="--parameter_fp" type="data" format="txt" label="Parameter file" help="It specifies changes to the default behavior, e.g. beta diversity metrics" optional="true"/>
        <param argument="--master_tree" type="select" label="Method for computing master trees in jackknife analysis">
            <option value="consensus" selected="True">Consensus of trees from jackknifed otu tables</option>
            <option value="full">Tree generated from input (unsubsambled) otu table</option>
        </param>
        <param argument="--parallel" type="boolean" label="Run in parallel where available?" truevalue="--parallel" falsevalue="" checked="true"/>
    </inputs>
    
    <outputs>
        <collection name="unrarefied_beta_div_dist_matrix" type="list" label="${tool.name} on ${on_string}: Distance matrix for unrarefied beta diversity">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.txt" directory="jackknifed_beta_diversity/unrarefied_bdiv/"/>
        </collection>
        <collection name="unrarefied_beta_div_tree" type="list" label="${tool.name} on ${on_string}: UPGMA trees for unrarefied beta diversity">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.tre" directory="jackknifed_beta_diversity/unrarefied_bdiv/"/>
        </collection>
        <collection name="rarefaction" type="list" label="${tool.name} on ${on_string}: Rarefied OTU tables">
            <discover_datasets pattern="rarefaction_(?P&lt;designation&gt;.+)\.biom" directory="jackknifed_beta_diversity/rarefaction/"/>
        </collection>
        <collection name="pcoa" type="list:paired" label="${tool.name} on ${on_string}: PCoA">
            <discover_datasets pattern="pcoa_(?P&lt;identifier_0&gt;.+)_rarefaction_(?P&lt;identifier_1&gt;.+)\.txt" ext="txt" directory="jackknifed_beta_diversity/pcoa/"/>
        </collection>
        <collection name="rare_dm" type="list:paired" label="${tool.name} on ${on_string}: Distance matrix for rarefied beta diversity">
            <discover_datasets pattern="(?P&lt;identifier_0&gt;.+)_rarefaction_(?P&lt;identifier_1&gt;.+)\.txt" ext="txt" directory="jackknifed_beta_diversity/rare_dm/"/>
        </collection>
        <collection name="rare_upgma" type="list:paired" label="${tool.name} on ${on_string}: UPGMA trees for unrarefied beta diversity">
            <discover_datasets pattern="upgma_(?P&lt;identifier_0&gt;.+)_rarefaction_(?P&lt;identifier_1&gt;.+)\.tre" ext="txt" directory="jackknifed_beta_diversity/rare_upgma/"/>
        </collection>
        <collection name="rare_upgma_consensus" type="list" label="${tool.name} on ${on_string}: Consensus UPGMA trees for unrarefied beta diversity">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.tre" directory="jackknifed_beta_diversity/rare_upgma_consensus/"/>
        </collection>
        <data name="jackknifed_beta_diversity_report" format="html" label="${tool.name} on ${on_string}: Report"/>
    </outputs>
    
    <tests>
        <test>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

This tool performs jackknifing (repeatedly resampling a subset of the available data from each sample) to measure robustness of individual UPGMA clusters and clusters in PCoA plots.

More information about this tool is available on
`QIIME documentation <http://qiime.org/scripts/jackknifed_beta_diversity.html>`_.
    ]]></help>
    
    <citations>
        <expand macro="citations"/>
    </citations>
</tool>
