<tool id="qiime_beta_diversity_through_plots" name="Compute beta diversity distance matrices" version="@WRAPPER_VERSION@.0">

    <description>and generate PCoA plots</description>

    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>

    <stdio>
        <regex match="VisibleDeprecationWarning" source="both" level="warning" description="VisibleDeprecationWarning on numpy for `rank`"/>
    </stdio>

    <version_command>beta_diversity_through_plots.py --version</version_command>

    <command detect_errors="aggressive"><![CDATA[
        beta_diversity_through_plots.py
            --otu_table_fp '$otu_table_fp'
            --mapping_fp '$mapping_fp'
            --beta_diversity_through_plots beta_diversity_through_plots
            #if $tree_fp
                --tree_fp '$tree_fp'
            #end if
            #if $parameter_fp
                --parameter_fp '$parameter_fp'
            #end if
            $parallel
            -O "\${GALAXY_SLOTS:-4}"
            #if $seqs_per_sample
                --seqs_per_sample '$seqs_per_sample'
            #end if
            '$suppress_emperor_plots'

        && python $__tool_directory__/beta_diversity_through_plots_html_generation.py
            --data_directory beta_diversity_through_plots
            --html_file '$beta_diversity_pcoa'
            --html_dir '$beta_diversity_pcoa.files_path'
    ]]></command>

    <inputs>
        <param argument="--otu_table_fp" type="data" format="tabular,txt,biom" multiple="True" label="OTU table"/>

        <param argument="--mapping_fp" type="data" format="tabular,txt" multiple="True" label="Mapping file" help=""/>

        <param argument="--tree_fp" type="data" format="txt" optional="True" label="Tree file (Optional)" help=""/>

        <param argument="--parameter_fp" type="data" format="txt" label="Parameter file (Optional)" help="It specifies changes to the default behavior, e.g. beta diversity metrics" optional="true"/>

        <param argument="--color_by_all_fields" type="text" optional="True" label="Colored mapping fields" help="Can be included only fields with greater than one value and fewer values than the number of samples"/>

        <param argument="--parallel" type="boolean" truevalue="--parallel" falsevalue="" checked="False" label="Run in parallel where available?" help=""/>

        <param argument="--seqs_per_sample" type="integer" optional="True" label="Depth of coverage for even sampling (Optional)" help=""/>

        <param argument="--suppress_emperor_plots" type="boolean" truevalue="" falsevalue="--suppress_emperor_plots" checked="True" label="Generate emperor plots?" help=""/>
    </inputs>

    <outputs>
        <data format="txt" name="beta_diversity_matrix">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)_dm\.txt" ext="txt" directory="beta_diversity_through_plots" visible="true"/>
        </data>
        <data format="txt" name="beta_diversity_pc">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)_pc\.txt" ext="txt" directory="beta_diversity_through_plots" visible="true"/>
        </data>
        <data format="html" name="beta_diversity_pcoa" label="${tool.name} on ${on_string}: PCoA"/>
    </outputs>

    <tests>
        <test>
            <param name="otu_table_fp" value=""/>
            <param name="mapping_fp" value=""/>
            <param name="parallel" value=""/>
            <param name="suppress_emperor_plots" truevalue=""/>
        </test>
    </tests>

    <help><![CDATA[
**What it does**

This tool computes beta diversity distance matrices and generates PCoA plots in
several steps

    - Performs beta diversity analysis
    - Performs principal coordinate analysis
    - Generates 3D PCoA Plots

More information about this tool is available on
`QIIME documentation <http://qiime.org/scripts/beta_diversity_through_plots.html>`_.
    ]]></help>

    <citations>
        <expand macro="citations"/>
    </citations>
</tool>
